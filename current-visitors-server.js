// Generated by CoffeeScript 1.9.1
(function() {
  "use strict";
  var connections, updateVisitors;

  connections = {};

  updateVisitors = function() {
    var id, modifier, path, ref, set, unset;
    set = {};
    unset = (ref = CurrentVisitors.findOne()) != null ? ref : {};
    delete unset._id;
    for (id in connections) {
      path = connections[id];
      path = path.replace(/\./g, '%2E');
      if (set[path] != null) {
        set[path] += 1;
      } else {
        set[path] = 1;
      }
      delete unset[path];
    }
    modifier = {};
    if (Object.keys(set).length > 0) {
      modifier.$set = set;
    }
    if (Object.keys(unset).length > 0) {
      modifier.$unset = unset;
    }
    CurrentVisitors.upsert({}, modifier);
  };

  Meteor.methods({
    'current-visitors': function(path) {
      if (this.connection == null) {
        return;
      }
      check(path, String);
      connections[this.connection.id] = path;
      updateVisitors();
    }
  });

  Meteor.publish('current-visitors', function() {
    return CurrentVisitors.find();
  });

  Meteor.onConnection(function(handle) {
    handle.onClose(function() {
      delete connections[handle.id];
      updateVisitors();
    });
  });

  CurrentVisitors.remove({});

  CurrentVisitors.insert({});

}).call(this);
