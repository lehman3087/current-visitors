// Generated by CoffeeScript 1.8.0
(function() {
  "use strict";
  var connections, updateVisitors;

  connections = {};

  updateVisitors = function() {
    var id, path, set, unset, _ref;
    set = {};
    unset = (_ref = CurrentVisitors.findOne()) != null ? _ref : {};
    delete unset._id;
    for (id in connections) {
      path = connections[id];
      path = path.replace(/\./g, '%2E');
      if (set[path] != null) {
        set[path] += 1;
      } else {
        set[path] = 1;
      }
      delete unset[path];
    }
    CurrentVisitors.upsert({}, {
      $set: set,
      $unset: unset
    });
  };

  Meteor.methods({
    'current-visitors': function(path) {
      if (this.connection == null) {
        return;
      }
      check(path, String);
      connections[this.connection.id] = path;
      updateVisitors();
    }
  });

  Meteor.publish('current-visitors', function() {
    return CurrentVisitors.find();
  });

  Meteor.onConnection(function(handle) {
    handle.onClose(function() {
      delete connections[handle.id];
      updateVisitors();
    });
  });

  CurrentVisitors.remove({});

  CurrentVisitors.insert({});

}).call(this);
